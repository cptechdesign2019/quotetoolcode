<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clearpoint AV Quoting Tool</title>
    <link rel="stylesheet" href="style.css">
    <!-- Montserrat for all text -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="cpheaderlogo.png" type="image/png">

    <!-- Third-party libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/5g5r6d0qvmki2axq6i6z1nv7pr4hml9guf5avd0kyzbmueyt/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body style="font-family: 'Montserrat', sans-serif; background: #f8fafc;">

    <!-- Header with logo and logout -->
    <header style="background: #003366; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 2rem;">
        <div style="display: flex; align-items: center;">
            <img src="cpheaderlogo.png" alt="Clearpoint Logo" style="height: 58px; margin-right: 18px;">
            <!-- <h1 style="font-size: 1.6rem; font-weight: 700; letter-spacing: 1.5px; margin: 0;">AV Quoting Tool</h1> -->
            <!-- Removed per user request -->
        </div>
        <button id="logoutButton" style="background: #dc3545; color: #fff; border: none; border-radius: 5px; padding: 10px 20px; font-size: 1rem; font-weight: 600; cursor: pointer; margin: 0 0 0 auto; display: none;">Logout</button>
    </header>

    <!-- Left Sidebar for Loading Quotes/Templates -->
    <aside id="loadQuoteSidebar" style="display:none; position:fixed; top:0; left:0; height:100vh; width:370px; background:#fff; box-shadow:2px 0 14px rgba(0,0,0,0.12); z-index:110; padding:32px 26px 24px 26px;">
        <button id="closeLoadQuoteSidebarBtn" style="position:absolute; top:20px; right:20px; background:none; border:none; font-size:2rem; color:#003366; cursor:pointer;">Ã—</button>
        <h3 style="margin-top:0;">Load Quote or Template</h3>
        <div id="templatesSection" style="margin-bottom: 32px;">
            <h4 style="margin:8px 0 6px 0; color:#0059b3;">Templates</h4>
            <ul id="templateList" style="list-style:none; padding:0;"></ul>
        </div>
        <div id="savedQuotesSection">
            <h4 style="margin:8px 0 6px 0; color:#0059b3;">Saved Quotes</h4>
            <ul id="savedQuotesList" style="list-style:none; padding:0;"></ul>
        </div>
    </aside>

    <!-- Login View -->
    <div id="loginView" class="view-container login-container" style="max-width:380px; margin:70px auto; background:#fff; box-shadow:0 4px 16px rgba(0,89,179,0.10); border-radius:12px; padding:40px;">
        <h2 style="color:#003366; font-weight:700;">Login</h2>
        <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" name="loginEmail" class="full-width" style="margin-bottom:16px;">
        </div>
        <div class="form-group">
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" name="loginPassword" class="full-width" style="margin-bottom:24px;">
        </div>
        <button id="loginButton" class="primary full-width" style="background:#0059b3; color:#fff; font-weight:600; border-radius:6px; padding:12px;">Login</button>
        <p id="loginError" class="error-message" style="color:#dc3545; margin-top:16px;"></p>
    </div>

    <!-- Main App Content -->
    <div id="mainAppContent" style="display:none;">
<!-- Floating Action Bar (right) -->
    <nav id="floatingActionBar" style="position: fixed; right: 32px; top: 120px; z-index: 100; display: flex; flex-direction: column; gap: 16px;">
        <button id="saveQuoteBarBtn" class="brand-action-btn" style="background: #0059b3;">Save Quote</button>
        <button id="saveAsTemplateBarBtn" class="brand-action-btn" style="background: #00b1e1;">Save as Template</button>
        <button id="newQuoteBarBtn" class="brand-action-btn" style="background: #28a745;">New Quote</button>
        <button id="loadQuoteBarBtn" class="brand-action-btn" style="background: #f39c12;">Load Quote</button>
    </nav>
        <main style="max-width: 1500px; background:#fff; margin:38px auto 30px auto; border-radius:14px; box-shadow:0 8px 36px rgba(0,89,179,0.08); padding:36px 36px 26px 36px;">
            <!-- Project Info -->
            <section id="project-info" style="margin-bottom:30px;">
                <h2 style="margin-top:0;">Project Information</h2>
                <div class="form-group" style="display:flex; gap:18px; align-items:center;">
                    <label for="projectNameNumber" style="min-width:160px;">Project Name & Number:</label>
                    <input type="text" id="projectNameNumber" name="projectNameNumber" placeholder="e.g., Conference Room Upgrade - PJ1001" class="full-width" style="flex:1;">
                </div>
                <div class="form-group" style="display:flex; gap:18px; align-items:center;">
                    <label for="quoteStatusSelector" style="min-width:160px;">Quote Status:</label>
                    <select id="quoteStatusSelector" style="height:40px;">
                        <option value="Draft">Draft</option>
                        <option value="SentToClient">Sent to Client</option>
                        <option value="Accepted">Accepted</option>
                        <option value="ChangesRequested">Changes Requested</option>
                        <option value="Archived">Archived</option>
                    </select>
                    <button id="updateStatusBtn" style="background: #0059b3; color: #fff; border-radius: 6px; border: none; padding: 9px 18px; font-weight: 600; margin-left:24px;">Update Status</button>
                </div>
            </section>

            <!-- Item Selection -->
            <section id="item-selector" style="margin-bottom: 30px;">
                <h2>Item Selection</h2>
                <div style="display:flex;gap:14px;">
                    <input type="text" id="productSearchInput" placeholder="Search by name, P/N, brand..." class="full-width" style="flex:2;">
                    <select id="brandFilterDropdown" style="flex:1;">
                        <option value="">All Brands</option>
                    </select>
                </div>
                <div style="margin:16px 0;">
                    <select id="productDropdown" class="full-width" disabled>
                        <option value="">-- Select a Product --</option>
                    </select>
                </div>
                <div id="dataLoadStatus" style="color:#999; font-size:0.98em; margin:6px 0 0 2px;">Loading product data...</div>
                <div id="addSuccessNotification" class="success-notification"></div>
                <div style="margin-top: 14px; display: flex; gap: 12px;">
                    <button id="addToQuoteBtn" style="background:#28a745; color:#fff; border:none; border-radius:6px; font-weight:600; padding:10px 22px;" disabled>Add to Quote</button>
                    
                </div>
            </section>

            <!-- Item Preview -->
            <section id="item-preview" style="margin-bottom:30px; display:flex; background:#f7fafd; border-radius:12px; box-shadow:0 2px 12px rgba(0,89,179,0.05); align-items:flex-start; gap:30px; padding:22px 24px;">
                <div id="item-preview-details" style="flex:2;">
                    <h3 id="item-preview-title" style="font-weight:700; color:#003366; margin:0 0 8px 0;">Item Details</h3>
                    <div id="item-preview-fields">
                        <div><strong>Name:</strong> <span id="item-preview-name"></span></div>
                        <div><strong>Product Number:</strong> <span id="item-preview-number"></span></div>
                        <div><strong>Brand:</strong> <span id="item-preview-brand"></span></div>
                        <div><strong>Category:</strong> <span id="item-preview-category"></span></div>
                        <div><strong>Type:</strong> <span id="item-preview-type"></span></div>
                        <div><strong>Description:</strong> <span id="item-preview-desc"></span></div>
                        <div><strong>MSRP:</strong> <span id="item-preview-msrp"></span></div>
                        <div><strong>MAP:</strong> <span id="item-preview-map"></span></div>
                        <div><strong>Cost Price:</strong> <span id="item-preview-cost"></span></div>
                        <div><strong>Spec Sheet:</strong> <a id="item-preview-specsheet" href="#" target="_blank" style="color:#0059b3;">View PDF</a></div>
                    </div>
                </div>
                <div id="item-preview-image-container" style="flex:1; display:flex; align-items:center; justify-content:center;">
                    <img id="item-preview-img" src="placeholderlogoimage.png" alt="Preview" style="max-width:160px; max-height:160px; border-radius:8px; border:1px solid #e4e9ef; background:#fff;">
                </div>
            </section>

            <!-- Current Quote Table -->
            <section id="quote-display" style="margin-bottom:34px;">
                <h2>Current Quote</h2>
                <div id="quoteItemsTableContainer" style="overflow-x:auto; background:#f5f8fc; border-radius:10px; margin-bottom:20px; padding:8px;">
                    <table id="quoteItemsTable" style="width:100%; min-width:900px;">
                       		 <thead>
  					<tr>
    						<th class="col-drag"></th>
    						<th class="col-image">Image</th>
    						<th class="col-product-name">Product Name</th>
    						<th class="col-product-number">P/N</th>
    						<th class="col-description" title="Description">Desc</th>
						<th class="col-cost-price">Cost</th>
    						<th class="col-markup">Markup %</th>
   					 	<th class="col-msrp">MSRP</th>
    						<th class="col-sell-price">Sell Price</th>
   						<th class="col-qty">Qty</th>
    						<th class="col-line-total">Line Total</th>
    						<th class="col-actions">Actions</th>
 					 </tr>
				</thead>
                        <tbody id="quoteItemsTbody"></tbody>
                    </table>
                </div>
                <p id="emptyQuoteMsg" style="color:#b0b0b0; text-align:center; margin:0;">Your equipment quote is currently empty.</p>
                <div id="quote-summary" style="margin:30px auto 0 auto; max-width:520px; background:#e6f0ff; border-radius:10px; padding:18px 22px;">
                    <h3 style="margin-top:0; color:#003366; font-size:1.1rem;">Equipment Quote Summary</h3>
                    <table id="quoteSummaryTable" style="width:100%;">
                        <tr><td>Total Equipment Client Price:</td><td id="summarySellTotal">$0.00</td></tr>
                        <tr><td>Total Equipment Company Cost:</td><td id="summaryCostTotal">$0.00</td></tr>
                        <tr><td>Equipment Profit (Difference):</td><td id="summaryProfitAmount">$0.00</td></tr>
                        <tr><td>Equipment Gross Profit Margin %:</td><td id="summaryGPM">0.00%</td></tr>
                    </table>
                </div>
            </section>

            <!-- Labor Section -->
            <section id="labor-section" style="margin-bottom:34px;">
                <h2>Labor</h2>
                <div id="laborItemsContainer"></div>
                <div id="labor-summary" style="margin-top:24px; max-width:520px; background:#e6f0ff; border-radius:10px; padding:18px 22px;">
                    <h3 style="margin-top:0; color:#003366; font-size:1.1rem;">Labor Summary</h3>
                    <table id="laborSummaryTable" style="width:100%;">
                        <tr><td>Total Labor Man-Hours:</td><td id="laborSummaryManHours">0.0</td></tr>
                        <tr><td>Total Labor Company Cost:</td><td id="laborSummaryCostTotal">$0.00</td></tr>
                        <tr><td>Total Labor Client Price:</td><td id="laborSummarySellTotal">$0.00</td></tr>
                        <tr><td>Labor Profit (Difference):</td><td id="laborSummaryProfitAmount">$0.00</td></tr>
                        <tr><td>Labor Gross Profit Margin %:</td><td id="laborSummaryGPM">0.00%</td></tr>
                    </table>
                </div>
            </section>

            <!-- Grand Totals Section -->
            <section id="grand-totals-section" style="margin-bottom:34px;">
                <h2>Grand Totals</h2>
                <div class="totals-grid" style="display:flex;gap:26px;">
                    <div class="adjustment-inputs" style="flex:1;">
                        <h3 style="margin-top:0;">Adjustments</h3>
                        <div class="input-group" style="margin-bottom:14px;">
                            <label for="discountPercent">Discount (%):</label>
                            <input type="number" id="discountPercent" value="0" min="0" step="0.01" style="margin-left:8px;width:80px;">
                        </div>
                        <div class="input-group" style="margin-bottom:14px;">
                            <label for="shippingPercent">Shipping (% of Equip.):</label>
                            <input type="number" id="shippingPercent" value="5" min="0" step="0.01" style="margin-left:8px;width:80px;">
                        </div>
                        <div class="input-group" style="margin-bottom:14px;">
                            <label for="salesTaxPercent">Sales Tax (%):</label>
                            <input type="number" id="salesTaxPercent" value="8" min="0" step="0.01" style="margin-left:8px;width:80px;">
                        </div>
                    </div>
                    <div class="financial-breakdown" style="flex:2;">
                        <h3 style="margin-top:0;">Financial Summary</h3>
                        <table class="summary-table" id="grandTotalsBreakdownTable" style="width:100%;">
                            <tr><td>Equipment Subtotal (Client):</td><td id="grandEquipmentClientTotal">$0.00</td></tr>
                            <tr><td>Labor Subtotal (Client):</td><td id="grandLaborClientTotal">$0.00</td></tr>
                            <tr class="subtotal-row"><td>Combined Subtotal:</td><td id="grandCombinedSubtotal">$0.00</td></tr>
                            <tr><td>Discount Amount (-):</td><td id="grandDiscountAmount">$0.00</td></tr>
                            <tr class="subtotal-row"><td>Subtotal After Discount:</td><td id="grandSubtotalAfterDiscount">$0.00</td></tr>
                            <tr><td>Shipping Amount (+):</td><td id="grandShippingAmount">$0.00</td></tr>
                            <tr><td>Sales Tax Amount (+):</td><td id="grandSalesTaxAmount">$0.00</td></tr>
                            <tr class="final-total-row"><td>FINAL CLIENT TOTAL:</td><td id="finalGrandTotal">$0.00</td></tr>
                            <tr class="separator-row"><td colspan="2"></td></tr>
                            <tr><td>Total Equipment Company Cost:</td><td id="grandEquipmentCompanyCost">$0.00</td></tr>
                            <tr><td>Total Labor Company Cost:</td><td id="grandLaborCompanyCost">$0.00</td></tr>
                            <tr class="subtotal-row"><td>Total Overall Company Cost:</td><td id="grandOverallCompanyCost">$0.00</td></tr>
                            <tr><td>Overall Profit Amount:</td><td id="grandOverallProfitAmount">$0.00</td></tr>
                            <tr><td>Overall Gross Profit Margin %:</td><td id="grandOverallGPM">0.00%</td></tr>
                        </table>
                    </div>
                </div>
            </section>

            <!-- SOW Section -->
            <section id="sow-editor-section" style="margin-bottom:30px;">
                <h2>Scope of Work</h2>
                <div class="sow-project-info" style="background:#f8f9fa; border-left:3px solid #003366; border-radius:0 8px 8px 0; padding:12px 18px; margin-bottom:20px;">
                    <strong>Project Name & Number:</strong> <span id="sowProjectNameNumber"></span>
                </div>
                <div id="sowAiPromptSection" style="background:#f0f5fb; padding:14px 18px; border-radius:8px; margin-bottom:0;">
                    <label for="sowAiPromptText" style="font-weight:600;">Describe what you want the AI to focus on or include in the SOW:</label>
                    <div class="sow-prompt-controls" style="display:flex;gap:10px;">
                        <textarea id="sowAiPromptText" rows="3" placeholder="e.g., Emphasize ease of use... Click the mic to use voice." style="flex:1;"></textarea>
                        <button type="button" id="sowMicBtn" class="mic-button" title="Use Microphone for Prompt" style="background:#00b1e1; color:#fff; border:none; border-radius:8px; font-size:1.8rem; padding:0 18px;">ðŸŽ¤</button>
                    </div>
                    <button id="draftFullSowWithAiBtn" style="background:#0059b3; color:#fff; border:none; border-radius:6px; font-weight:600; padding:10px 22px; margin-top:10px;">Draft Full SOW with AI</button>
                </div>
                <div class="sow-input-group" style="margin-top:20px;">
                    <label for="sowFullOutputText" style="font-weight:600;">Generated Scope of Work:</label>
                    <textarea id="sowFullOutputText" class="sow-textarea" rows="14" placeholder="AI-generated SOW will appear here..." style="width:100%; min-height:200px;"></textarea>
                </div>
            </section>

            <!-- Action Buttons -->
            <div id="quote-actions-final" class="persistent-actions" style="margin-top:34px; text-align:right;">
                <button id="saveQuoteBtn" style="background:#0059b3; color:#fff; border-radius:6px; border:none; padding:10px 20px; font-weight:600;">Save Quote</button>
                <button id="viewSpecSheetsBtn" style="background:#00b1e1; color:#fff; border-radius:6px; border:none; padding:10px 20px; font-weight:600;">View Spec Sheets</button>
                <button id="printQuoteBtn" style="background:#28a745; color:#fff; border-radius:6px; border:none; padding:10px 20px; font-weight:600;">Print Quote</button>
                <button id="downloadPdfBtn" style="background:#f39c12; color:#fff; border-radius:6px; border:none; padding:10px 20px; font-weight:600;">Download Quote (PDF)</button>
                <button id="downloadSowPdfBtn" style="display:none;background:#f39c12; color:#fff; border-radius:6px; border:none; padding:10px 20px; font-weight:600;">Download SOW (PDF)</button>
            </div>
        </main>

        <!-- Footer -->
        <footer style="text-align:center; padding:1.5rem; background:#003366; color:#f8f9fa; margin-top:0; font-size:0.93rem; border-radius:0 0 14px 14px;">
            <p>&copy; <span id="currentYear"></span> Clearpoint Technology & Design</p>
        </footer>
    </div>

    <!-- Modal for Spec Sheets -->
    <div id="specSheetModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); padding-top:40px;">
        <div class="modal-content" style="background:#fff; margin:5% auto; padding:25px; border:1px solid #e4e9ef; width:92%; max-width:480px; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.12);">
            <span class="modal-close-button" style="color:#aaa; float:right; font-size:28px; font-weight:bold; line-height:1; cursor:pointer;">&times;</span>
            <h2>Equipment Spec Sheets</h2>
            <div id="specSheetLinksContainer">
                <p>No spec sheets found for items in the current quote.</p>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
