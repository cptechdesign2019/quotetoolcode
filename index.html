<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clearpoint AV Quoting Tool</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="placeholderlogoimage.png" type="image/png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/5g5r6d0qvmki2axq6i6z1nv7pr4hml9guf5avd0kyzbmueyt/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6"></script>
</head>
<body>
    <header>
        <h1>Clearpoint Technology & Design - AV Quoting Tool</h1>
        <button id="logoutButton" style="display:none; float: right; margin-top: -30px; background-color: #dc3545;">Logout</button>
    </header>

    <div id="loginView" class="view-container" style="max-width: 400px; margin: 50px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h2>Login</h2>
        <div style="margin-bottom: 15px;">
            <label for="loginEmail" style="display: block; margin-bottom: 5px;">Email:</label>
            <input type="email" id="loginEmail" name="loginEmail" style="width: 100%; padding: 8px; box-sizing: border-box;">
        </div>
        <div style="margin-bottom: 20px;">
            <label for="loginPassword" style="display: block; margin-bottom: 5px;">Password:</label>
            <input type="password" id="loginPassword" name="loginPassword" style="width: 100%; padding: 8px; box-sizing: border-box;">
        </div>
        <button id="loginButton" style="width: 100%; padding: 10px; background-color: var(--clearpoint-primary-blue); color: white; border: none; border-radius: 4px; cursor: pointer;">Login</button>
        <p id="loginError" style="color: red; margin-top: 10px; text-align: center;"></p>
    </div>

    <div id="mainAppContent" style="display:none;">

        <div id="loadQuoteSidebar" class="sidebar">
            <h3>Load Existing Quote</h3>
            <div id="savedQuotesList" class="saved-quotes-list">
                <p>Loading saved quotes...</p>
            </div>
            <button id="closeLoadQuoteSidebarBtn" class="sidebar-close-button">Close</button>
        </div>
        <main>
            <div id="view-navigation" class="view-navigation-tabs">
                <button id="navigateToQuoteBuilderBtn" class="view-nav-button active">Quote Builder</button>
                <button id="navigateToSowBtn" class="view-nav-button">Scope of Work</button>
                <button id="newQuoteBtn" class="view-nav-button" style="margin-left: auto; background-color: var(--success-green); color: white;">New Quote</button>
                <button id="toggleLoadQuoteSidebarBtn" class="view-nav-button" style="background-color: var(--clearpoint-dark-blue); color: white;">Load Quote</button>
            </div>

            <div id="quoteBuilderView" class="view-container active-view">
                <section id="project-info">
                    <h2>Project Details</h2>
                    <div>
                        <label for="projectNameNumber">Project Name & Number:</label>
                        <input type="text" id="projectNameNumber" name="projectNameNumber" placeholder="e.g., Conference Room Upgrade - PJ1001">
                    </div>
                    <div class="status-selector-container">
                        <label for="quoteStatusSelector">Quote Status:</label>
                        <select id="quoteStatusSelector">
                            <option value="Draft">Draft</option>
                            <option value="SentToClient">Sent to Client</option>
                            <option value="Accepted">Accepted</option>
                            <option value="ChangesRequested">Changes Requested</option>
                            <option value="Archived">Archived</option>
                        </select>
                        <button id="updateStatusBtn" class="status-update-button" style="width: auto; padding: 6px 12px; font-size: 0.85rem; margin-left: 10px; vertical-align: middle;">Update Status</button>
                    </div>
                    </section>

                <section id="item-selector">
                    <h2>Select Item (Equipment)</h2>
                    <div class="search-controls-container">
                        <input type="text" id="productSearchInput" placeholder="Search by Name, P/N, Brand...">
                        <select id="brandFilterDropdown">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    <div class="product-dropdown-container">
                        <select id="productDropdown" disabled>
                            <option value="">-- Select a Product --</option>
                        </select>
                    </div>
                    <p id="dataLoadStatus">Loading product data...</p>
                    <div id="addSuccessNotification" class="success-notification"></div>
                    <div class="item-selector-actions">
                        <button id="addToQuoteBtn" disabled>Add to Quote</button>
                        <button id="refreshDataBtn">Refresh Product List</button>
                    </div>
                </section>

                <section id="item-preview">
                    <h2>Item Preview</h2>
                    <div id="previewArea">
                        <p>Select an item from the dropdown to see its details here.</p>
                    </div>
                </section>

                <section id="quote-display">
                    <h2>Current Equipment Quote</h2>
                    <div id="quoteItemsTableContainer">
                        <table id="quoteItemsTable">
                            <thead>
                                <tr>
                                    <th class="col-image">Image</th>
                                    <th class="col-product-name">Product Name</th>
                                    <th class="col-product-number">P/N</th>
                                    <th class="col-description">Description</th>
                                    <th class="col-cost-price">Cost Price</th>
                                    <th class="col-markup">Markup %</th>
                                    <th class="col-msrp">MSRP</th>
                                    <th class="col-sell-price">Sell Price</th>
                                    <th class="col-qty">Qty</th>
                                    <th class="col-line-total">Line Total</th>
                                    <th class="col-actions">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quoteItemsTbody"></tbody>
                        </table>
                    </div>
                    <p id="emptyQuoteMsg">Your equipment quote is currently empty.</p>

                    <div id="quote-summary">
                        <h3>Equipment Quote Summary</h3>
                        <table id="quoteSummaryTable">
                            <tr><td>Total Equipment Company Cost:</td><td id="summaryCostTotal">$0.00</td></tr>
                            <tr><td>Total Equipment Client Price:</td><td id="summarySellTotal">$0.00</td></tr>
                            <tr><td>Equipment Profit (Difference):</td><td id="summaryProfitAmount">$0.00</td></tr>
                            <tr><td>Equipment Gross Profit Margin %:</td><td id="summaryGPM">0.00%</td></tr>
                        </table>
                    </div>
                </section>

                <section id="labor-section">
                    <h2>Labor Details</h2>
                    <div id="laborItemsContainer"></div>
                    <div id="labor-summary">
                        <h3>Labor Summary</h3>
                        <table id="laborSummaryTable">
                            <tr><td>Total Labor Man-Hours:</td><td id="laborSummaryManHours">0.0</td></tr>
                            <tr><td>Total Labor Company Cost:</td><td id="laborSummaryCostTotal">$0.00</td></tr>
                            <tr><td>Total Labor Client Price:</td><td id="laborSummarySellTotal">$0.00</td></tr>
                            <tr><td>Labor Profit (Difference):</td><td id="laborSummaryProfitAmount">$0.00</td></tr>
                            <tr><td>Labor Gross Profit Margin %:</td><td id="laborSummaryGPM">0.00%</td></tr>
                        </table>
                    </div>
                </section>

                <section id="grand-totals-section">
                    <h2>Grand Totals & Adjustments</h2>
                    <div class="totals-grid">
                        <div class="adjustment-inputs">
                            <h3>Adjustments</h3>
                            <div class="input-group"><label for="discountPercent">Discount (%):</label><input type="number" id="discountPercent" value="0" min="0" step="0.01"></div>
                            <div class="input-group"><label for="shippingPercent">Shipping (% of Equip.):</label><input type="number" id="shippingPercent" value="5" min="0" step="0.01"></div>
                            <div class="input-group"><label for="salesTaxPercent">Sales Tax (%):</label><input type="number" id="salesTaxPercent" value="8" min="0" step="0.01"></div>
                        </div>
                        <div class="financial-breakdown">
                            <h3>Financial Summary</h3>
                            <table class="summary-table" id="grandTotalsBreakdownTable">
                                <tr><td>Equipment Subtotal (Client):</td><td id="grandEquipmentClientTotal">$0.00</td></tr>
                                <tr><td>Labor Subtotal (Client):</td><td id="grandLaborClientTotal">$0.00</td></tr>
                                <tr class="subtotal-row"><td>Combined Subtotal:</td><td id="grandCombinedSubtotal">$0.00</td></tr>
                                <tr><td>Discount Amount (-):</td><td id="grandDiscountAmount">$0.00</td></tr>
                                <tr class="subtotal-row"><td>Subtotal After Discount:</td><td id="grandSubtotalAfterDiscount">$0.00</td></tr>
                                <tr><td>Shipping Amount (+):</td><td id="grandShippingAmount">$0.00</td></tr>
                                <tr><td>Sales Tax Amount (+):</td><td id="grandSalesTaxAmount">$0.00</td></tr>
                                <tr class="final-total-row"><td>FINAL CLIENT TOTAL:</td><td id="finalGrandTotal">$0.00</td></tr>
                                <tr class="separator-row"><td colspan="2"></td></tr>
                                <tr><td>Total Equipment Company Cost:</td><td id="grandEquipmentCompanyCost">$0.00</td></tr>
                                <tr><td>Total Labor Company Cost:</td><td id="grandLaborCompanyCost">$0.00</td></tr>
                                <tr class="subtotal-row"><td>Total Overall Company Cost:</td><td id="grandOverallCompanyCost">$0.00</td></tr>
                                <tr><td>Overall Profit Amount:</td><td id="grandOverallProfitAmount">$0.00</td></tr>
                                <tr><td>Overall Gross Profit Margin %:</td><td id="grandOverallGPM">0.00%</td></tr>
                            </table>
                        </div>
                    </div>
                </section>
            </div>

            <div id="sowView" class="view-container" style="display: none;">
                 <section id="sow-editor-section">
                    <h2>Scope of Work</h2>
                    <div id="sowProjectInfoDisplay" class="sow-project-info">
                        <strong>Project Name & Number:</strong> <span id="sowProjectNameNumber"></span>
                    </div>

                    <div id="sowAiPromptSection">
                        <label for="sowAiPromptText">Describe what you want the AI to focus on or include in the SOW:</label>
                        <div class="sow-prompt-controls">
                            <textarea id="sowAiPromptText" rows="3" placeholder="e.g., Emphasize ease of use... Click the mic to use voice."></textarea>
                            <button type="button" id="sowMicBtn" class="mic-button" title="Use Microphone for Prompt">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="mic-icon-default">
                                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.86 14.49 16 12 16s-4.58-1.14-4.93-4.15a.998.998 0 0 0-.98-.85c-.55 0-1 .45-1 1 0 3.03 2.16 5.54 5 5.92V21h-2c-.55 0-1 .45-1 1s.45 1 1 1h6c.55 0 1-.45 1-1s-.45-1-1-1h-2v-2.08c2.84-.38 5-2.89 5-5.92 0-.55-.45-1-1-1z"/>
                                </svg>
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18" fill="currentColor" class="mic-icon-recording" style="display:none;">
                                    <path d="M12 15c2.21 0 4-1.79 4-4V5c0-2.21-1.79-4-4-4S8 2.79 8 5v6c0 2.21 1.79 4 4 4zm0-12c1.1 0 2 .9 2 2v6c0 1.1-.9 2-2 2s-2-.9-2-2V5c0-1.1.9-2 2-2zm0 14c-2.53 0-4.62-1.89-4.95-4.37h-.02c-.5 0-.93-.39-.93-.87v-.26c0-.5.43-.9.93-.9h.02C7.38 8.89 9.47 7 12 7s4.62 1.89 4.95 4.37h.02c.5 0 .93.39.93.87v-.26c0 .5-.43-.9-.93-.9h-.02C16.62 15.11 14.53 17 12 17zm7-6h-1.09c-.09-1.63-.66-3.12-1.54-4.34L17.5 5.5C18.89 7.16 19.5 9.03 19.5 11c0 .34-.02.67-.05.99L19 12V11zm-2.09 0H16V9.92c.06-.32.09-.64.09-.92 0-1.97-.61-3.84-2-5.5l-1.17 1.17c.88 1.22 1.45 2.71 1.54 4.33zM5.05 12H5l.05-.99C5.02 10.67 5 10.34 5 10c0-1.97.61-3.84 2-5.5L5.83 3.33C4.55 4.88 4 6.88 4 9c0 .28.03.59.09.88V12h.96zM6.5 5.5L5.33 4.33C6.21 3.12 6.78 1.63 6.87 0H7.91v1.08C7.16 3.62 6.5 7.06 6.5 11v1h1.09z"/>
                                </svg>
                            </button>
                        </div>
                        <button id="draftFullSowWithAiBtn">Draft Full SOW with AI</button>
                    </div>

                    <div class="sow-input-group" style="margin-top: 20px;">
                        <label for="sowFullOutputText">Generated Scope of Work:</label>
                        <textarea id="sowFullOutputText" class="sow-textarea" rows="25" placeholder="AI-generated SOW will appear here..."></textarea>
                    </div>
                </section>
            </div>

            <div id="quote-actions-final" class="persistent-actions">
                <button id="saveQuoteBtn">Save Quote</button>
                <button id="viewSpecSheetsBtn">View Spec Sheets</button>
                <button id="printQuoteBtn">Print Quote</button>
                <button id="downloadPdfBtn">Download Quote (PDF)</button>
                <button id="downloadSowPdfBtn" style="display: none;">Download SOW (PDF)</button>
            </div>
        </main>

        <footer>
            <p>&copy; <span id="currentYear"></span> Clearpoint Technology & Design</p>
        </footer>
    </div> <div id="specSheetModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h2>Equipment Spec Sheets</h2>
            <div id="specSheetLinksContainer">
                <p>No spec sheets found for items in the current quote.</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <script src="script.js"></script>
</body>
</html>